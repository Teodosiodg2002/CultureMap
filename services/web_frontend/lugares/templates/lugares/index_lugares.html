{% extends 'lugares/base.html' %}

{% block title %}CultureMap - Inicio{% endblock %}

{% block content %}

<style>
  /* Filtro para convertir el marcador azul en rojo/rosado */
  img.icono-evento {
    filter: hue-rotate(140deg);
  }
  
  /* Estilo para el control de capas personalizado */
  .filtro-control {
    background: white;
    padding: 10px 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
    display: inline-block;
  }
</style>

<div class="container-fluid py-4">
  
  <div class="row mb-3 align-items-center">
    <div class="col-md-6">
      <h1 class="display-5 fw-bold">Explora Granada</h1>
      <p class="text-muted">Descubre la cultura a tu alrededor</p>
    </div>
    
    <div class="col-md-6 text-md-end">
        <div class="filtro-control shadow-sm">
            <span class="fw-bold me-2"><i class="bi bi-funnel-fill"></i> Filtros:</span>
            
            <div class="form-check form-switch form-check-inline">
                <input class="form-check-input" type="checkbox" id="switchLugares" checked onchange="toggleCapa('lugares')">
                <label class="form-check-label fw-bold text-primary" for="switchLugares">
                    üîµ Lugares
                </label>
            </div>
            
            <div class="form-check form-switch form-check-inline">
                <input class="form-check-input" type="checkbox" id="switchEventos" checked onchange="toggleCapa('eventos')">
                <label class="form-check-label fw-bold text-danger" for="switchEventos">
                    üî¥ Eventos
                </label>
            </div>
        </div>
    </div>
  </div>

  {% if error %}
  <div class="alert alert-warning shadow-sm mb-4" role="alert">
    <i class="bi bi-exclamation-triangle-fill"></i> {{ error }}
  </div>
  {% endif %}

  <div class="row mb-5">
    <div class="col-12">
      <div
        id="map"
        class="shadow border"
        style="height: 500px; border-radius: 12px; overflow: hidden;"
      ></div>
    </div>
  </div>

  <div class="row g-4">
    
    <div class="col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-bottom border-primary border-3">
           <h3 class="text-primary mb-0"><i class="bi bi-bank2"></i> Lugares Destacados</h3>
        </div>
        <div class="list-group list-group-flush">
        {% for lugar in lugares %}
          <a
            href="{% url 'detalle_lugar' lugar.id %}"
            class="list-group-item list-group-item-action p-3"
          >
            <div class="d-flex w-100 justify-content-between align-items-center mb-1">
              <h5 class="mb-0 text-primary">{{ lugar.nombre }}</h5>
              <span class="badge bg-info text-dark rounded-pill">{{ lugar.categoria }}</span>
            </div>
            <p class="mb-1 text-secondary">{{ lugar.descripcion|truncatewords:15 }}</p>
          </a>
        {% empty %}
          <div class="list-group-item text-center text-muted py-4">
            No hay lugares disponibles en este momento.
          </div>
        {% endfor %}
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-bottom border-danger border-3">
           <h3 class="text-danger mb-0"><i class="bi bi-calendar-event"></i> Pr√≥ximos Eventos</h3>
        </div>
        <div class="list-group list-group-flush">
        {% for evento in eventos %}
          <a href="{% url 'detalle_evento' evento.id %}" class="list-group-item list-group-item-action p-3">
            <div class="d-flex w-100 justify-content-between align-items-center mb-1">
              <h5 class="mb-0 text-danger">{{ evento.nombre }}</h5>
              <span class="badge bg-danger rounded-pill">
                {{ evento.fecha_inicio|slice:":10" }}
              </span>
            </div>
            <p class="mb-1 text-secondary">{{ evento.descripcion|truncatewords:15 }}</p>
            <small class="text-muted"><i class="bi bi-geo-alt-fill text-danger"></i> Ver detalles</small>
          </a>
        {% empty %}
          <div class="list-group-item text-center text-muted py-4">
            No hay eventos pr√≥ximos programados.
          </div>
        {% endfor %}
        </div>
      </div>
    </div>

  </div>

  {% if request.session.rol == 'admin' or request.session.rol == 'organizador' %}
  <div class="row mt-5 mb-5">
    <div class="col-12">
      <div class="card bg-dark text-white p-4 shadow text-center" style="border-radius: 15px;">
        <div class="card-body">
            <h3 class="card-title text-warning"><i class="bi bi-gear-fill"></i> Zona de Gesti√≥n</h3>
            <p class="card-text">
              Tienes permisos especiales para gestionar el contenido de la plataforma.
            </p>
            <a href="{% url 'dashboard' %}" class="btn btn-warning btn-lg fw-bold px-5 rounded-pill">
              <i class="bi bi-speedometer2"></i> Ir al Panel de Administraci√≥n
            </a>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

</div>

{% endblock %} 

{% block scripts %}
<script>
  // Variables globales para las capas
  var map;
  var layerLugares;
  var layerEventos;

  document.addEventListener('DOMContentLoaded', function () {

      // 1. Inicializar mapa centrado en Granada
      map = L.map('map').setView([37.1773, -3.5986], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      // 2. Definir Icono Rojo
      var redIcon = new L.Icon({
          iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
          shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41],
          className: 'icono-evento'
      });

      // 3. Crear LayerGroups (Grupos de capas vac√≠os al principio)
      layerLugares = L.layerGroup();
      layerEventos = L.layerGroup();

      // 4. Rellenar Capa LUGARES
      {% for lugar in lugares %}
          {% if lugar.lat and lugar.lng %}
              var marker = L.marker([{{ lugar.lat }}, {{ lugar.lng }}])
               .bindPopup(`
                 <div class="text-center">
                    <h6 class="text-primary mb-1">üèõÔ∏è <a href="{% url 'detalle_lugar' lugar.id %}" class="text-decoration-none">{{ lugar.nombre|escapejs }}</a></h6>
                    <span class="badge bg-info text-dark">{{ lugar.categoria|escapejs }}</span><br>
                    <small class="text-muted">${"{{ lugar.descripcion|escapejs }}".substring(0, 50)}...</small>
                 </div>
               `);
              // A√ëADIR A LA CAPA, NO AL MAPA DIRECTAMENTE
              layerLugares.addLayer(marker);
          {% endif %}
      {% endfor %}

      // 5. Rellenar Capa EVENTOS
      {% for evento in eventos %}
          {% if evento.lat and evento.lng %}
              var marker = L.marker([{{ evento.lat }}, {{ evento.lng }}], {icon: redIcon})
               .bindPopup(`
                 <div class="text-center">
                    <h6 class="text-danger mb-1">üìÖ <a href="{% url 'detalle_evento' evento.id %}" class="text-decoration-none text-danger">{{ evento.nombre|escapejs }}</a></h6>
                    <span class="badge bg-danger">{{ evento.fecha_inicio|slice:":10" }}</span><br>
                    <small class="text-muted">${"{{ evento.descripcion|escapejs }}".substring(0, 50)}...</small>
                 </div>
               `);
              // A√ëADIR A LA CAPA
              layerEventos.addLayer(marker);
          {% endif %}
      {% endfor %}

      // 6. A√±adir ambas capas al mapa inicialmente (porque los checkbox est√°n checked)
      map.addLayer(layerLugares);
      map.addLayer(layerEventos);
  });

  // 7. Funci√≥n global para encender/apagar capas
  function toggleCapa(tipo) {
      if (tipo === 'lugares') {
          var checkbox = document.getElementById('switchLugares');
          if (checkbox.checked) {
              map.addLayer(layerLugares);
          } else {
              map.removeLayer(layerLugares);
          }
      } else if (tipo === 'eventos') {
          var checkbox = document.getElementById('switchEventos');
          if (checkbox.checked) {
              map.addLayer(layerEventos);
          } else {
              map.removeLayer(layerEventos);
          }
      }
  }
</script>
{% endblock %}