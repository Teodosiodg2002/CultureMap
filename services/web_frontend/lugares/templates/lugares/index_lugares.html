{% extends 'lugares/base.html' %}

{% block title %}CultureMap - Inicio{% endblock %}

{% block content %}

<style>
    /* Truco CSS: Cambia el color del marcador rotando el tono (Hue) */
    /* 140deg convierte el azul en rojo/rosado */
    img.icono-evento { filter: hue-rotate(140deg); }
    /* 280deg convierte el azul en verde (opcional) */
    /* img.icono-otro { filter: hue-rotate(280deg); } */
</style>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-8">
            <h1>Explora Granada</h1>
            <p>
                <span style="color: #2c82e0;">üîµ <b>Lugares</b></span> &nbsp;|&nbsp; 
                <span style="color: #e0462c;">üî¥ <b>Eventos</b></span>
            </p>
        </div>
    </div>

    {% if error %}
        <div class="alert alert-warning">{{ error }}</div>
    {% endif %}

    <div class="row mb-5">
        <div class="col-12">
            <div id="map" class="shadow-sm border" style="height: 500px; border-radius: 10px;"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <h3 class="text-primary border-bottom pb-2">üèõÔ∏è Lugares Destacados</h3>
            <div class="list-group">
                {% for lugar in lugares %}
                    <a href="{% url 'detalle_lugar' lugar.id %}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">{{ lugar.nombre }}</h5>
                            <small class="text-muted">{{ lugar.categoria }}</small>
                        </div>
                        <p class="mb-1">{{ lugar.descripcion|truncatewords:15 }}</p>
                    </a>
                {% empty %}
                    <div class="alert alert-light">No hay lugares disponibles.</div>
                {% endfor %}
            </div>
        </div>

        <div class="col-md-6">
            <h3 class="text-danger border-bottom pb-2">üìÖ Pr√≥ximos Eventos</h3>
            <div class="list-group">
                {% for evento in eventos %}
                    <div class="list-group-item list-group-item-action flex-column align-items-start">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">{{ evento.nombre }}</h5>
                            <small class="text-danger">
                                {{ evento.fecha_inicio|slice:":10" }} </small>
                        </div>
                        <p class="mb-1">{{ evento.descripcion|truncatewords:15 }}</p>
                        <small class="text-muted">üìç Ver en el mapa (Pin Rojo)</small>
                    </div>
                {% empty %}
                    <div class="alert alert-light">No hay eventos pr√≥ximos.</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        
        // 1. Inicializar mapa centrado en Granada
        var map = L.map('map').setView([37.1773, -3.5986], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // 2. Definir el Icono ROJO (para eventos)
        var redIcon = new L.Icon({
            iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41],
            className: 'icono-evento' // <--- Esta clase aplica el filtro de color rojo
        });

        // 3. Pintar LUGARES (Azul por defecto)
        {% for lugar in lugares %}
            {% if lugar.lat and lugar.lng %}
                L.marker([{{ lugar.lat }}, {{ lugar.lng }}])
                 .addTo(map)
                 .bindPopup(`
                    <b>üèõÔ∏è <a href="{% url 'detalle_lugar' lugar.id %}">{{ lugar.nombre|escapejs }}</a></b><br>
                    ${"{{ lugar.descripcion|escapejs }}".substring(0, 50)}...
                 `);
            {% endif %}
        {% endfor %}

        // 4. Pintar EVENTOS (Rojo)
        {% for evento in eventos %}
            {% if evento.lat and evento.lng %}
                L.marker([{{ evento.lat }}, {{ evento.lng }}], {icon: redIcon})
                 .addTo(map)
                 .bindPopup(`
                    <b>üìÖ {{ evento.nombre|escapejs }}</b><br>
                    Fecha: {{ evento.fecha_inicio|slice:":10" }}<br>
                    ${"{{ evento.descripcion|escapejs }}".substring(0, 50)}...
                 `);
            {% endif %}
        {% endfor %}
    });
</script>
{% endblock %}